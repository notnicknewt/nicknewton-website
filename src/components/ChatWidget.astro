---
// Daisy Chat Widget - Interactive AI coach
// Integrates with backend API at https://coachinghub-api-production.up.railway.app/leadbot/api/chat
---

<div id="daisy-chat-widget">
  <!-- Chat prompt popup -->
  <div
    id="chat-prompt"
    class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden"
  >
    <div class="bg-brand-gray rounded-lg shadow-2xl border border-brand-accent/30 p-8 max-w-sm text-center">
      <div class="w-16 h-16 bg-brand-accent rounded-full flex items-center justify-center mx-auto mb-4">
        <span class="text-white font-bold text-2xl">D</span>
      </div>
      <h3 class="text-xl font-bold text-brand-text mb-2">
        Not sure if this is right for you?
      </h3>
      <p class="text-brand-muted mb-6">
        Let's find out.
      </p>
      <div class="flex flex-col gap-3">
        <button
          id="prompt-chat-btn"
          class="btn-primary py-3 px-6 w-full"
        >
          Chat Now
        </button>
        <button
          id="prompt-dismiss-btn"
          class="text-brand-muted hover:text-brand-text text-sm transition-colors"
        >
          Maybe later
        </button>
      </div>
    </div>
  </div>

  <!-- Chat prompt backdrop -->
  <div
    id="chat-prompt-backdrop"
    class="fixed inset-0 bg-black/70 z-40 hidden"
  ></div>

  <!-- Chat bubble (closed state) -->
  <button
    id="chat-bubble"
    class="fixed bottom-6 right-6 z-50 bg-brand-accent hover:bg-red-700 text-white rounded-full p-4 shadow-2xl transition-all duration-300 hover:scale-110"
    aria-label="Open chat with Daisy"
  >
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
    <span class="absolute -top-1 -right-1 bg-brand-accent text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center animate-pulse">
      !
    </span>
  </button>

  <!-- Backdrop overlay -->
  <div
    id="chat-backdrop"
    class="fixed inset-0 bg-black/70 z-40 hidden"
  ></div>

  <!-- Chat window (open state) -->
  <div
    id="chat-window"
    class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 w-96 max-w-[calc(100vw-3rem)] h-[600px] max-h-[calc(100vh-6rem)] bg-brand-gray rounded-lg shadow-2xl border border-brand-accent/30 flex flex-col hidden"
  >
    <!-- Header -->
    <div class="bg-brand-dark border-b border-brand-accent/30 p-4 rounded-t-lg flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-brand-accent rounded-full flex items-center justify-center">
          <span class="text-white font-bold text-lg">D</span>
        </div>
        <div>
          <h3 class="text-brand-text font-semibold text-sm">Daisy | Client Success Coach</h3>
          <p class="text-brand-muted text-xs">let's see if we're a fit</p>
        </div>
      </div>
      <button
        id="close-chat"
        class="text-brand-muted hover:text-brand-text transition-colors"
        aria-label="Close chat"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Messages container -->
    <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
      <!-- Initial message -->
      <div class="flex gap-3">
        <div class="w-8 h-8 bg-brand-accent rounded-full flex items-center justify-center flex-shrink-0">
          <span class="text-white font-bold text-sm">D</span>
        </div>
        <div class="bg-brand-dark p-3 rounded-lg max-w-[80%]">
          <p class="text-brand-text text-sm">
            Hey! I'm Daisy, @daisy_bell1989 - I work with Nick on the coaching and accountability
          </p>
        </div>
      </div>
    </div>

    <!-- Contact form (shown until captured) -->
    <div id="contact-form" class="border-t border-brand-accent/30 p-4 bg-brand-dark/50">
      <p class="text-brand-muted text-xs mb-2">So we can follow up:</p>
      <div class="flex gap-2 mb-2">
        <input
          type="email"
          id="user-email"
          placeholder="Email"
          class="flex-1 bg-brand-gray text-brand-text px-3 py-2 rounded text-sm border border-brand-muted focus:border-brand-accent focus:outline-none"
        />
      </div>
      <input
        type="tel"
        id="user-phone"
        placeholder="Phone"
        class="w-full bg-brand-gray text-brand-text px-3 py-2 rounded text-sm border border-brand-muted focus:border-brand-accent focus:outline-none"
      />
    </div>

    <!-- Input area -->
    <div class="border-t border-brand-accent/30 p-4">
      <div class="flex gap-2">
        <input
          type="text"
          id="user-input"
          placeholder="Type your message..."
          class="flex-1 bg-brand-dark text-brand-text px-4 py-3 rounded-lg border border-brand-muted focus:border-brand-accent focus:outline-none"
        />
        <button
          id="send-message"
          class="bg-brand-accent hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors font-semibold"
        >
          Send
        </button>
      </div>
      <p class="text-brand-muted text-xs mt-2 italic">
        Straight talk, no fluff. Ask anything.
      </p>
    </div>
  </div>
</div>

<script>
  // Daisy Chat Widget Logic
  class DaisyChat {
    private sessionId: string | null = null;
    private contactCaptured: boolean = false;
    private apiBaseUrl: string = 'https://coachinghub-api-production.up.railway.app/leadbot/api/chat';

    constructor() {
      this.initializeSession();
      this.attachEventListeners();
      this.loadChatHistory();
    }

    private initializeSession(): void {
      // Get or create session ID
      this.sessionId = localStorage.getItem('daisy_session_id');
      if (!this.sessionId) {
        this.sessionId = this.generateSessionId();
        localStorage.setItem('daisy_session_id', this.sessionId);
      }

      // Check if contact already captured
      const captured = localStorage.getItem('daisy_contact_captured');
      this.contactCaptured = captured === 'true';

      if (this.contactCaptured) {
        this.hideContactForm();
      }
    }

    private generateSessionId(): string {
      return 'daisy_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
    }

    private attachEventListeners(): void {
      const chatBubble = document.getElementById('chat-bubble');
      const closeChat = document.getElementById('close-chat');
      const sendMessage = document.getElementById('send-message');
      const userInput = document.getElementById('user-input') as HTMLInputElement;

      const backdrop = document.getElementById('chat-backdrop');

      chatBubble?.addEventListener('click', () => this.openChat());
      closeChat?.addEventListener('click', () => this.closeChat());
      backdrop?.addEventListener('click', () => this.closeChat());
      sendMessage?.addEventListener('click', () => this.sendMessage());

      userInput?.addEventListener('keypress', (e: KeyboardEvent) => {
        if (e.key === 'Enter') {
          this.sendMessage();
        }
      });

      // Listen for custom events
      window.addEventListener('daisy:open', () => this.openChat());
    }

    private openChat(): void {
      const bubble = document.getElementById('chat-bubble');
      const chatWindow = document.getElementById('chat-window');
      const backdrop = document.getElementById('chat-backdrop');

      bubble?.classList.add('hidden');
      chatWindow?.classList.remove('hidden');
      backdrop?.classList.remove('hidden');

      // Dispatch custom event
      this.dispatchEvent('daisy:opened');

      // Focus input
      setTimeout(() => {
        const input = document.getElementById('user-input') as HTMLInputElement;
        input?.focus();
      }, 100);
    }

    private closeChat(): void {
      const bubble = document.getElementById('chat-bubble');
      const chatWindow = document.getElementById('chat-window');
      const backdrop = document.getElementById('chat-backdrop');

      chatWindow?.classList.add('hidden');
      backdrop?.classList.add('hidden');
      bubble?.classList.remove('hidden');

      // Dispatch custom event
      this.dispatchEvent('daisy:closed');
    }

    private async sendMessage(): Promise<void> {
      const input = document.getElementById('user-input') as HTMLInputElement;
      const message = input?.value.trim();

      if (!message) return;

      // Add user message to UI
      this.addMessage(message, 'user');
      input.value = '';

      // Show typing indicator
      this.showTypingIndicator();

      // Collect contact info if available
      const emailInput = document.getElementById('user-email') as HTMLInputElement;
      const phoneInput = document.getElementById('user-phone') as HTMLInputElement;
      const email = emailInput?.value.trim() || undefined;
      const phone = phoneInput?.value.trim() || undefined;

      try {
        // Send to API
        const response = await fetch(this.apiBaseUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: this.sessionId,
            message: message,
            email: email,
            phone: phone,
          }),
        });

        if (!response.ok) {
          throw new Error('Failed to send message');
        }

        const data = await response.json();

        // Remove typing indicator
        this.hideTypingIndicator();

        // Add bot response
        this.addMessage(data.response, 'bot');

        // Update session if new
        if (data.session_id && data.session_id !== this.sessionId) {
          this.sessionId = data.session_id;
          if (this.sessionId) {
            localStorage.setItem('daisy_session_id', this.sessionId);
          }
        }

        // Handle contact captured
        if (data.contact_captured && !this.contactCaptured) {
          this.contactCaptured = true;
          localStorage.setItem('daisy_contact_captured', 'true');
          this.hideContactForm();
          this.dispatchEvent('daisy:contact_captured', { email, phone });
        }

      } catch (error) {
        console.error('Chat error:', error);
        this.hideTypingIndicator();
        this.addMessage(
          "Sorry, I'm having trouble connecting right now. Try again in a moment.",
          'bot'
        );
      }
    }

    private async loadChatHistory(): Promise<void> {
      if (!this.sessionId) return;

      try {
        const response = await fetch(
          `${this.apiBaseUrl}/history?session_id=${this.sessionId}`
        );

        if (!response.ok) return;

        const data = await response.json();

        if (data.messages && data.messages.length > 0) {
          // Clear initial message
          const container = document.getElementById('messages-container');
          if (container) {
            container.innerHTML = '';
          }

          // Add historical messages
          data.messages.forEach((msg: any) => {
            this.addMessage(msg.content, msg.role === 'assistant' ? 'bot' : 'user');
          });
        }
      } catch (error) {
        console.error('Failed to load chat history:', error);
      }
    }

    private addMessage(text: string, sender: 'user' | 'bot'): void {
      const container = document.getElementById('messages-container');
      if (!container) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = sender === 'user' ? 'flex gap-3 justify-end' : 'flex gap-3';

      if (sender === 'bot') {
        messageDiv.innerHTML = `
          <div class="w-8 h-8 bg-brand-accent rounded-full flex items-center justify-center flex-shrink-0">
            <span class="text-white font-bold text-sm">D</span>
          </div>
          <div class="bg-brand-dark p-3 rounded-lg max-w-[80%]">
            <p class="text-brand-text text-sm">${this.escapeHtml(text)}</p>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="bg-brand-accent p-3 rounded-lg max-w-[80%]">
            <p class="text-white text-sm">${this.escapeHtml(text)}</p>
          </div>
        `;
      }

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    private showTypingIndicator(): void {
      const container = document.getElementById('messages-container');
      if (!container) return;

      const typingDiv = document.createElement('div');
      typingDiv.id = 'typing-indicator';
      typingDiv.className = 'flex gap-3';
      typingDiv.innerHTML = `
        <div class="w-8 h-8 bg-brand-accent rounded-full flex items-center justify-center flex-shrink-0">
          <span class="text-white font-bold text-sm">D</span>
        </div>
        <div class="bg-brand-dark p-3 rounded-lg">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-brand-muted rounded-full animate-bounce" style="animation-delay: 0ms"></div>
            <div class="w-2 h-2 bg-brand-muted rounded-full animate-bounce" style="animation-delay: 150ms"></div>
            <div class="w-2 h-2 bg-brand-muted rounded-full animate-bounce" style="animation-delay: 300ms"></div>
          </div>
        </div>
      `;

      container.appendChild(typingDiv);
      container.scrollTop = container.scrollHeight;
    }

    private hideTypingIndicator(): void {
      const indicator = document.getElementById('typing-indicator');
      indicator?.remove();
    }

    private hideContactForm(): void {
      const form = document.getElementById('contact-form');
      form?.classList.add('hidden');
    }

    private escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    private dispatchEvent(eventName: string, detail?: any): void {
      window.dispatchEvent(new CustomEvent(eventName, { detail }));
    }
  }

  // Chat Prompt Popup Logic
  class ChatPrompt {
    private shown: boolean = false;
    private dismissed: boolean = false;
    private chatOpened: boolean = false;
    private timeoutId: number | null = null;

    constructor() {
      // Check if already shown this session
      if (sessionStorage.getItem('daisy_prompt_shown') === 'true') {
        this.shown = true;
        return;
      }

      this.attachEventListeners();
      this.startTriggers();
    }

    private attachEventListeners(): void {
      const chatBtn = document.getElementById('prompt-chat-btn');
      const dismissBtn = document.getElementById('prompt-dismiss-btn');
      const backdrop = document.getElementById('chat-prompt-backdrop');

      chatBtn?.addEventListener('click', () => {
        this.hidePrompt();
        window.dispatchEvent(new CustomEvent('daisy:open'));
      });

      dismissBtn?.addEventListener('click', () => this.hidePrompt());
      backdrop?.addEventListener('click', () => this.hidePrompt());

      // Listen for chat open events to prevent showing prompt if chat is already open
      window.addEventListener('daisy:opened', () => {
        this.chatOpened = true;
        this.hidePrompt();
      });

      window.addEventListener('daisy:closed', () => {
        this.chatOpened = false;
      });
    }

    private startTriggers(): void {
      // Time trigger: 30 seconds
      this.timeoutId = window.setTimeout(() => {
        this.tryShowPrompt();
      }, 30000);

      // Scroll trigger: 40% of page
      window.addEventListener('scroll', () => {
        const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
        if (scrollPercent >= 40) {
          this.tryShowPrompt();
        }
      });
    }

    private tryShowPrompt(): void {
      if (this.shown || this.dismissed || this.chatOpened) return;

      // Don't show if chat window is already open
      const chatWindow = document.getElementById('chat-window');
      if (chatWindow && !chatWindow.classList.contains('hidden')) return;

      this.showPrompt();
    }

    private showPrompt(): void {
      if (this.shown) return;

      this.shown = true;
      sessionStorage.setItem('daisy_prompt_shown', 'true');

      const prompt = document.getElementById('chat-prompt');
      const backdrop = document.getElementById('chat-prompt-backdrop');

      prompt?.classList.remove('hidden');
      backdrop?.classList.remove('hidden');

      // Clear timeout if it's still pending
      if (this.timeoutId) {
        clearTimeout(this.timeoutId);
      }
    }

    private hidePrompt(): void {
      this.dismissed = true;

      const prompt = document.getElementById('chat-prompt');
      const backdrop = document.getElementById('chat-prompt-backdrop');

      prompt?.classList.add('hidden');
      backdrop?.classList.add('hidden');
    }
  }

  // Initialize chat widget when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new DaisyChat();
      new ChatPrompt();
    });
  } else {
    new DaisyChat();
    new ChatPrompt();
  }
</script>

<style>
  #messages-container {
    scrollbar-width: thin;
    scrollbar-color: #d4311a #1a1a1a;
  }

  #messages-container::-webkit-scrollbar {
    width: 6px;
  }

  #messages-container::-webkit-scrollbar-track {
    background: #1a1a1a;
  }

  #messages-container::-webkit-scrollbar-thumb {
    background: #d4311a;
    border-radius: 3px;
  }
</style>
